<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart GST Billing System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            body { margin: 0; padding: 15px; font-size: 11px; }
            .print-container { 
                width: 100%; 
                max-width: 210mm; 
                margin: 0 auto; 
                page-break-after: avoid;
            }
            .invoice-table { 
                border-collapse: collapse; 
                width: 100%; 
                font-size: 10px;
                margin: 10px 0;
            }
            .invoice-table th, .invoice-table td { 
                border: 1px solid #000; 
                padding: 4px 6px; 
                text-align: left; 
                word-wrap: break-word;
            }
            .print-header { 
                border-bottom: 2px solid #000; 
                padding-bottom: 8px; 
                margin-bottom: 12px; 
            }
            .print-footer { 
                border-top: 2px solid #000; 
                padding-top: 8px; 
                margin-top: 12px; 
            }
            h1, h2, h3 { margin: 5px 0; }
            p { margin: 2px 0; }
        }
        @media screen { .print-container { display: none; } }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chat-bubble { animation: fadeInUp 0.3s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .status-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
        .status-paid { background-color: #d1fae5; color: #065f46; }
        .status-unpaid { background-color: #fee2e2; color: #991b1b; }
        .status-partial { background-color: #fef3c7; color: #92400e; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script>
    (function() {
        'use strict';
        
        const { useState, useEffect, useRef, createElement: h } = React;
        const { render } = ReactDOM;
        
        // Initialize Supabase
        const SUPABASE_URL = 'https://yylahhomjnijsybazxpt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5bGFoaG9tam5panN5YmF6eHB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTIzMDgsImV4cCI6MjA4NTYyODMwOH0.hkQmKxKSZivIzcEG4_3fVT5wrPbgSy9dL1Y2w44Gb5w';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Helper functions
        const numberToWords = (num) => {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            
            if (num === 0) return 'Zero';
            
            const convert = (n) => {
                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
                if (n < 1000) return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' ' + convert(n % 100) : '');
                if (n < 100000) return convert(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 ? ' ' + convert(n % 1000) : '');
                if (n < 10000000) return convert(Math.floor(n / 100000)) + ' Lakh' + (n % 100000 ? ' ' + convert(n % 100000) : '');
                return convert(Math.floor(n / 10000000)) + ' Crore' + (n % 10000000 ? ' ' + convert(n % 10000000) : '');
            };
            
            const rupees = Math.floor(num);
            const paise = Math.round((num - rupees) * 100);
            let result = convert(rupees) + ' Rupees';
            if (paise > 0) result += ' and ' + convert(paise) + ' Paise';
            return result + ' Only';
        };
        
        const getCurrentDate = () => new Date().toISOString().split('T')[0];
        
        // Auth Component
        const AuthPage = ({ onAuthSuccess }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [rememberMe, setRememberMe] = useState(true);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    if (isLogin) {
                        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                        if (rememberMe) localStorage.setItem('rememberMe', 'true');
                        onAuthSuccess(data.user);
                    } else {
                        const { data, error } = await supabase.auth.signUp({ email, password });
                        if (error) throw error;
                        if (data.user && data.user.identities && data.user.identities.length === 0) {
                            setError('User already exists. Please login.');
                        } else {
                            alert('Check your email for verification link!');
                            setIsLogin(true);
                        }
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            const handleGoogleAuth = async () => {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo: window.location.origin }
                });
                if (error) setError(error.message);
            };
            
            return h('div', { className: 'min-h-screen flex items-center justify-center gradient-bg p-4' },
                h('div', { className: 'bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md' },
                    h('div', { className: 'text-center mb-8' },
                        h('div', { className: 'text-5xl mb-3' }, 'ðŸ’¼'),
                        h('h1', { className: 'text-3xl font-bold text-gray-800 mb-2' }, 'Smart GST Billing'),
                        h('p', { className: 'text-gray-600' }, isLogin ? 'Welcome back!' : 'Get started for free')
                    ),
                    error && h('div', { className: 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm' }, error),
                    h('form', { onSubmit: handleAuth, className: 'space-y-4' },
                        h('div', {},
                            h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Email'),
                            h('input', {
                                type: 'email',
                                value: email,
                                onChange: e => setEmail(e.target.value),
                                required: true,
                                className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',
                                placeholder: 'your@email.com'
                            })
                        ),
                        h('div', {},
                            h('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Password'),
                            h('input', {
                                type: 'password',
                                value: password,
                                onChange: e => setPassword(e.target.value),
                                required: true,
                                minLength: 6,
                                className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',
                                placeholder: 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'
                            })
                        ),
                        isLogin && h('div', { className: 'flex items-center' },
                            h('input', {
                                type: 'checkbox',
                                id: 'remember',
                                checked: rememberMe,
                                onChange: e => setRememberMe(e.target.checked),
                                className: 'h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded'
                            }),
                            h('label', { htmlFor: 'remember', className: 'ml-2 block text-sm text-gray-700' }, 'Remember me')
                        ),
                        h('button', {
                            type: 'submit',
                            disabled: loading,
                            className: 'w-full gradient-bg text-white py-3 px-4 rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium text-lg'
                        }, loading ? 'Loading...' : (isLogin ? 'Sign In' : 'Sign Up')),
                        h('div', { className: 'relative my-4' },
                            h('div', { className: 'absolute inset-0 flex items-center' },
                                h('div', { className: 'w-full border-t border-gray-300' })
                            ),
                            h('div', { className: 'relative flex justify-center text-sm' },
                                h('span', { className: 'px-2 bg-white text-gray-500' }, 'Or continue with')
                            )
                        ),
                        h('button', {
                            type: 'button',
                            onClick: handleGoogleAuth,
                            className: 'w-full bg-white border-2 border-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-50 transition font-medium flex items-center justify-center gap-2'
                        }, 'ðŸ” Google')
                    ),
                    h('div', { className: 'text-center mt-6' },
                        h('button', {
                            type: 'button',
                            onClick: () => { setIsLogin(!isLogin); setError(''); },
                            className: 'text-purple-600 hover:text-purple-700 text-sm font-medium'
                        }, isLogin ? "Don't have an account? Sign Up" : "Already have an account? Sign In")
                    )
                )
            );
        };
        
        // AI Chatbot Component
        const AIChatbot = ({ invoices, customers, products, user }) => {
            const [messages, setMessages] = useState([{ role: 'assistant', content: 'Hi! I\'m your AI assistant. Ask me anything about your business data!' }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const messagesEndRef = useRef(null);
            
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);
            
            const generateContext = () => {
                const totalRevenue = invoices.reduce((sum, inv) => sum + parseFloat(inv.totals.gt), 0);
                const paidInvoices = invoices.filter(i => i.payment_status === 'paid');
                const unpaidInvoices = invoices.filter(i => i.payment_status === 'unpaid');
                const topCustomers = {};
                invoices.forEach(inv => {
                    topCustomers[inv.customer.name] = (topCustomers[inv.customer.name] || 0) + parseFloat(inv.totals.gt);
                });
                const sortedCustomers = Object.entries(topCustomers).sort((a,b) => b[1] - a[1]).slice(0, 5);
                
                return `Business Data Summary:
- Total Invoices: ${invoices.length}
- Total Revenue: â‚¹${totalRevenue.toFixed(2)}
- Paid Invoices: ${paidInvoices.length}
- Unpaid Invoices: ${unpaidInvoices.length}
- Total Customers: ${customers.length}
- Total Products: ${products.length}
- Top 5 Customers: ${sortedCustomers.map(([name, amt]) => `${name} (â‚¹${amt.toFixed(2)})`).join(', ')}

Recent Invoices:
${invoices.slice(0, 5).map(inv => `- Invoice ${inv.invoiceNumber}: ${inv.customer.name}, â‚¹${inv.totals.gt}, ${inv.payment_status}`).join('\n')}`;
            };
            
            const sendMessage = async () => {
                if (!input.trim()) return;
                
                const userMessage = { role: 'user', content: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setLoading(true);
                
                try {
                    const context = generateContext();
                    // Call our serverless API instead of Groq directly
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: [...messages.slice(-5), userMessage],
                            context: `You are a helpful business assistant for a GST billing system. Answer questions based on the following business data:\n\n${context}\n\nProvide concise, helpful answers with numbers and insights.`
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to get AI response');
                    }
                    
                    const data = await response.json();
                    const aiMessage = { role: 'assistant', content: data.choices[0].message.content };
                    setMessages(prev => [...prev, aiMessage]);
                } catch (err) {
                    console.error('AI Error:', err);
                    setMessages(prev => [...prev, { role: 'assistant', content: 'Sorry, I encountered an error. Please try again.' }]);
                } finally {
                    setLoading(false);
                }
            };
            
            return h('div', { className: 'flex flex-col h-full' },
                h('div', { className: 'flex-1 overflow-y-auto p-4 space-y-4' },
                    messages.map((msg, idx) => 
                        h('div', { key: idx, className: `chat-bubble flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}` },
                            h('div', { className: `max-w-[80%] px-4 py-2 rounded-2xl ${msg.role === 'user' ? 'gradient-bg text-white' : 'bg-gray-100 text-gray-800'}` },
                                h('p', { className: 'text-sm whitespace-pre-wrap' }, msg.content)
                            )
                        )
                    ),
                    loading && h('div', { className: 'flex justify-start' },
                        h('div', { className: 'bg-gray-100 px-4 py-2 rounded-2xl' },
                            h('div', { className: 'flex space-x-2' },
                                h('div', { className: 'w-2 h-2 bg-gray-400 rounded-full animate-bounce' }),
                                h('div', { className: 'w-2 h-2 bg-gray-400 rounded-full animate-bounce', style: { animationDelay: '0.1s' } }),
                                h('div', { className: 'w-2 h-2 bg-gray-400 rounded-full animate-bounce', style: { animationDelay: '0.2s' } })
                            )
                        )
                    ),
                    h('div', { ref: messagesEndRef })
                ),
                h('div', { className: 'border-t p-4' },
                    h('div', { className: 'flex gap-2' },
                        h('input', {
                            type: 'text',
                            value: input,
                            onChange: e => setInput(e.target.value),
                            onKeyPress: e => e.key === 'Enter' && sendMessage(),
                            placeholder: 'Ask about your sales, customers, invoices...',
                            className: 'flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent'
                        }),
                        h('button', {
                            onClick: sendMessage,
                            disabled: !input.trim() || loading,
                            className: 'gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 disabled:opacity-50 font-medium'
                        }, 'âž¤')
                    )
                )
            );
        };
        
        // Dashboard Component
        const Dashboard = ({ invoices, customers, products }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            useEffect(() => {
                if (chartRef.current && invoices.length > 0) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Destroy existing chart
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    // Group invoices by month
                    const monthlyData = {};
                    invoices.forEach(inv => {
                        const month = inv.date.substring(0, 7);
                        monthlyData[month] = (monthlyData[month] || 0) + parseFloat(inv.totals.gt);
                    });
                    
                    const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
                    const values = sortedMonths.map(m => monthlyData[m]);
                    
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: sortedMonths.map(m => {
                                const [y, mo] = m.split('-');
                                return new Date(y, mo - 1).toLocaleDateString('default', { month: 'short', year: 'numeric' });
                            }),
                            datasets: [{
                                label: 'Revenue',
                                data: values,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: value => 'â‚¹' + value.toLocaleString()
                                    }
                                }
                            }
                        }
                    });
                }
            }, [invoices]);
            
            const totalRevenue = invoices.reduce((sum, inv) => sum + parseFloat(inv.totals.gt), 0);
            const paidRevenue = invoices.filter(i => i.payment_status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.totals.gt), 0);
            const unpaidRevenue = invoices.filter(i => i.payment_status === 'unpaid').reduce((sum, inv) => sum + parseFloat(inv.totals.gt), 0);
            const partialRevenue = invoices.filter(i => i.payment_status === 'partial').reduce((sum, inv) => sum + (parseFloat(inv.totals.gt) - parseFloat(inv.amount_paid || 0)), 0);
            
            const topCustomers = {};
            invoices.forEach(inv => {
                topCustomers[inv.customer.name] = (topCustomers[inv.customer.name] || 0) + parseFloat(inv.totals.gt);
            });
            const sortedCustomers = Object.entries(topCustomers).sort((a,b) => b[1] - a[1]).slice(0, 5);
            
            return h('div', { className: 'space-y-6' },
                // Stats Cards
                h('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6' },
                    [
                        { title: 'Total Revenue', value: `â‚¹${totalRevenue.toLocaleString()}`, icon: 'ðŸ’°', color: 'from-blue-500 to-blue-600' },
                        { title: 'Paid', value: `â‚¹${paidRevenue.toLocaleString()}`, icon: 'âœ…', color: 'from-green-500 to-green-600' },
                        { title: 'Pending', value: `â‚¹${(unpaidRevenue + partialRevenue).toLocaleString()}`, icon: 'â³', color: 'from-yellow-500 to-yellow-600' },
                        { title: 'Total Invoices', value: invoices.length, icon: 'ðŸ“„', color: 'from-purple-500 to-purple-600' }
                    ].map((stat, idx) =>
                        h('div', { key: idx, className: 'bg-white rounded-xl shadow-lg p-6 card-hover' },
                            h('div', { className: 'flex items-center justify-between' },
                                h('div', {},
                                    h('p', { className: 'text-gray-500 text-sm font-medium' }, stat.title),
                                    h('p', { className: 'text-3xl font-bold text-gray-800 mt-2' }, stat.value)
                                ),
                                h('div', { className: `text-4xl bg-gradient-to-r ${stat.color} w-16 h-16 rounded-xl flex items-center justify-center` }, stat.icon)
                            )
                        )
                    )
                ),
                
                // Revenue Chart
                h('div', { className: 'bg-white rounded-xl shadow-lg p-6' },
                    h('h3', { className: 'text-xl font-bold text-gray-800 mb-4' }, 'ðŸ“ˆ Revenue Trend'),
                    h('div', { style: { height: '300px' } },
                        h('canvas', { ref: chartRef })
                    )
                ),
                
                // Top Customers
                h('div', { className: 'bg-white rounded-xl shadow-lg p-6' },
                    h('h3', { className: 'text-xl font-bold text-gray-800 mb-4' }, 'ðŸŒŸ Top Customers'),
                    h('div', { className: 'space-y-3' },
                        sortedCustomers.length === 0 ? 
                        h('p', { className: 'text-gray-500 text-center py-8' }, 'No customer data yet') :
                        sortedCustomers.map(([name, amount], idx) =>
                            h('div', { key: idx, className: 'flex items-center justify-between p-3 bg-gray-50 rounded-lg' },
                                h('div', { className: 'flex items-center gap-3' },
                                    h('div', { className: 'w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 flex items-center justify-center text-white font-bold' }, (idx + 1)),
                                    h('span', { className: 'font-medium text-gray-800' }, name)
                                ),
                                h('span', { className: 'font-bold text-purple-600' }, `â‚¹${amount.toLocaleString()}`)
                            )
                        )
                    )
                )
            );
        };
        
        // Main Billing App
        const BillingApp = ({ user, onLogout }) => {
            const [view, setView] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [invNum, setInvNum] = useState('INV-001');
            const [invDate, setInvDate] = useState(getCurrentDate());
            const [taxInc, setTaxInc] = useState(false);
            const [config, setConfig] = useState(null);
            const [fromDate, setFromDate] = useState('');
            const [toDate, setToDate] = useState('');
            const [discount, setDiscount] = useState(0);
            const [searchQuery, setSearchQuery] = useState('');
            const [showChatbot, setShowChatbot] = useState(false);
            
            const [custName, setCustName] = useState('');
            const [custAddr, setCustAddr] = useState('');
            const [custGST, setCustGST] = useState('');
            const [custPhone, setCustPhone] = useState('');
            
            const [items, setItems] = useState([{id:1,name:'',hsn:'33074100',qty:1,unit:'Pcs',rate:0,mrp:0,freeQty:0,freeUnit:'Pcs',discount:0}]);
            const [custs, setCusts] = useState([]);
            const [prods, setProds] = useState([]);
            const [invs, setInvs] = useState([]);
            const [stock, setStock] = useState([]);
            const [showStockForm, setShowStockForm] = useState(false);
            const [stockFormData, setStockFormData] = useState({name:'',rate:0});
            const [editingStock, setEditingStock] = useState(null);
            const [paymentModal, setPaymentModal] = useState(null);
            
            // Category state
            const [categories, setCategories] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [showCategoryForm, setShowCategoryForm] = useState(false);
            const [categoryFormData, setCategoryFormData] = useState({name:'',description:'',default_hsn:'33074100',has_mrp:false});
            const [editingCategory, setEditingCategory] = useState(null);
            const [categoryFilter, setCategoryFilter] = useState('');
            
            useEffect(() => {
                loadAllData();
            }, []);
            
            const loadAllData = async () => {
                setLoading(true);
                try {
                    await Promise.all([
                        loadProfile(),
                        loadCustomers(),
                        loadProducts(),
                        loadInvoices(),
                        loadCategories()
                    ]);
                    await generateNextInvoiceNumber();
                } catch (err) {
                    console.error('Error loading data:', err);
                } finally {
                    setLoading(false);
                }
            };
            
            const loadProfile = async () => {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (data) {
                    setConfig({
                        name: data.business_name || 'Your Business Name',
                        address: data.business_address || 'Your Address',
                        gstin: data.gstin || '',
                        phone: data.phone || '',
                        email: data.email || user.email,
                        bankName: data.bank_name || '',
                        accountNo: data.account_no || '',
                        ifsc: data.ifsc || ''
                    });
                } else {
                    setConfig({
                        name: 'Your Business Name',
                        address: 'Your Address',
                        gstin: '',
                        phone: '',
                        email: user.email,
                        bankName: '',
                        accountNo: '',
                        ifsc: ''
                    });
                }
            };
            
            const loadCustomers = async () => {
                const { data } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('name');
                if (data) setCusts(data);
            };
            
            const loadProducts = async () => {
                const { data } = await supabase
                    .from('product_rates')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('name');
                if (data) {
                    setStock(data);
                    setProds(data);
                }
            };
            
            const loadCategories = async () => {
                const { data } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('name');
                if (data) setCategories(data);
            };
            
            const loadInvoices = async () => {
                const { data } = await supabase
                    .from('invoices')
                    .select('*, categories(id, name)')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });
                
                if (data) {
                    const transformed = await Promise.all(data.map(async inv => {
                        const { data: items } = await supabase
                            .from('invoice_items')
                            .select('*')
                            .eq('invoice_id', inv.id);
                        
                        return {
                            invoiceNumber: inv.invoice_number,
                            date: inv.date,
                            customer: {
                                name: inv.customer_name,
                                address: inv.customer_address,
                                gstin: inv.customer_gstin,
                                phone: inv.customer_phone
                            },
                            items: items.map(it => ({
                                name: it.item_name,
                                hsn: it.hsn,
                                qty: it.quantity,
                                unit: it.unit,
                                rate: it.rate,
                                freeQty: it.free_qty,
                                freeUnit: it.free_unit,
                                discount: it.discount
                            })),
                            taxInclusive: inv.tax_inclusive,
                            discount: inv.discount,
                            totals: {
                                sub: inv.subtotal,
                                discAmt: inv.discount_amount,
                                afterDisc: inv.after_discount,
                                cg: inv.cgst,
                                sg: inv.sgst,
                                gt: inv.grand_total,
                                tq: inv.total_quantity,
                                ti: inv.total_items,
                                words: inv.amount_words
                            },
                            payment_status: inv.payment_status || 'unpaid',
                            amount_paid: inv.amount_paid || 0,
                            payment_date: inv.payment_date,
                            payment_notes: inv.payment_notes,
                            category: inv.categories,
                            category_id: inv.category_id,
                            id: inv.id
                        };
                    }));
                    setInvs(transformed);
                }
            };
            
            const generateNextInvoiceNumber = async () => {
                const { data } = await supabase
                    .from('invoices')
                    .select('invoice_number')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (data && data.length > 0) {
                    const lastNum = parseInt(data[0].invoice_number.split('-')[1]);
                    setInvNum(`INV-${String(lastNum + 1).padStart(3, '0')}`);
                } else {
                    setInvNum('INV-001');
                }
            };
            
            const saveProfile = async () => {
                const { error } = await supabase
                    .from('user_profiles')
                    .upsert({
                        id: user.id,
                        business_name: config.name,
                        business_address: config.address,
                        gstin: config.gstin,
                        phone: config.phone,
                        email: config.email,
                        bank_name: config.bankName,
                        account_no: config.accountNo,
                        ifsc: config.ifsc
                    });
                
                if (!error) alert('Settings saved!');
            };
            
            const saveCategory = async () => {
                if (!categoryFormData.name) {
                    alert('Category name is required!');
                    return;
                }
                
                if (editingCategory) {
                    const { error } = await supabase
                        .from('categories')
                        .update({
                            name: categoryFormData.name,
                            description: categoryFormData.description,
                            default_hsn: categoryFormData.default_hsn,
                            has_mrp: categoryFormData.has_mrp
                        })
                        .eq('id', editingCategory.id);
                    if (error) {
                        alert('Error updating category: ' + error.message + '\n\nPlease run categories-schema.sql in Supabase first!');
                        console.error('Category update error:', error);
                    } else {
                        await loadCategories();
                        setShowCategoryForm(false);
                        setEditingCategory(null);
                        setCategoryFormData({name:'',description:'',default_hsn:'33074100',has_mrp:false});
                        alert('Category updated!');
                    }
                } else {
                    const { error } = await supabase
                        .from('categories')
                        .insert({
                            user_id: user.id,
                            name: categoryFormData.name,
                            description: categoryFormData.description,
                            default_hsn: categoryFormData.default_hsn,
                            has_mrp: categoryFormData.has_mrp
                        });
                    if (error) {
                        alert('Error adding category: ' + error.message + '\n\nPlease run categories-schema.sql in Supabase first!');
                        console.error('Category insert error:', error);
                    } else {
                        await loadCategories();
                        setShowCategoryForm(false);
                        setCategoryFormData({name:'',description:'',default_hsn:'33074100',has_mrp:false});
                        alert('Category added!');
                    }
                }
            };
            
            const deleteCategory = async (id) => {
                if (!confirm('Delete this category? Related invoices will lose category reference.')) return;
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', id);
                if (!error) {
                    await loadCategories();
                    alert('Category deleted!');
                }
            };
            
            const saveInvoice = async () => {
                if (!selectedCategory) {
                    alert('Please select a category first!');
                    return;
                }
                
                const tots = calcTotals();
                
                const { data: invData, error: invError } = await supabase
                    .from('invoices')
                    .insert({
                        user_id: user.id,
                        invoice_number: invNum,
                        date: invDate,
                        customer_name: custName,
                        customer_address: custAddr,
                        customer_gstin: custGST,
                        customer_phone: custPhone,
                        tax_inclusive: taxInc,
                        discount: parseFloat(discount) || 0,
                        subtotal: parseFloat(tots.sub),
                        discount_amount: parseFloat(tots.discAmt),
                        after_discount: parseFloat(tots.afterDisc),
                        cgst: parseFloat(tots.cg),
                        sgst: parseFloat(tots.sg),
                        grand_total: parseFloat(tots.gt),
                        total_quantity: tots.tq,
                        total_items: tots.ti,
                        amount_words: tots.words,
                        payment_status: 'unpaid',
                        amount_paid: 0,
                        category_id: selectedCategory.id
                    })
                    .select()
                    .single();
                
                if (invError) {
                    alert('Error saving invoice: ' + invError.message);
                    return;
                }
                
                const itemsToInsert = items.filter(i => i.name).map(it => {
                    const c = calcLine(it);
                    return {
                        invoice_id: invData.id,
                        item_name: it.name,
                        hsn: it.hsn,
                        quantity: parseFloat(it.qty),
                        unit: it.unit,
                        rate: parseFloat(it.rate),
                        free_qty: parseFloat(it.freeQty) || 0,
                        free_unit: it.freeUnit,
                        discount: parseFloat(it.discount) || 0,
                        base_amount: parseFloat(c.base),
                        cgst: parseFloat(c.cgst),
                        sgst: parseFloat(c.sgst),
                        total: parseFloat(c.tot)
                    };
                });
                
                await supabase.from('invoice_items').insert(itemsToInsert);
                
                if (custName && !custs.find(c => c.name === custName)) {
                    await supabase.from('customers').insert({
                        user_id: user.id,
                        name: custName,
                        address: custAddr,
                        gstin: custGST,
                        phone: custPhone
                    });
                }
                
                for (const it of items.filter(i => i.name)) {
                    if (!prods.find(p => p.name === it.name)) {
                        await supabase.from('product_rates').insert({
                            user_id: user.id,
                            name: it.name,
                            rate: parseFloat(it.rate) || 0
                        });
                    }
                }
                
                await loadAllData();
                alert('Invoice saved successfully!');
                // Stay in invoice view to see the saved bill
            };
            
            const updatePaymentStatus = async (invoice, status, amountPaid, notes) => {
                const { error } = await supabase
                    .from('invoices')
                    .update({
                        payment_status: status,
                        amount_paid: parseFloat(amountPaid) || 0,
                        payment_date: status === 'paid' ? getCurrentDate() : null,
                        payment_notes: notes || null
                    })
                    .eq('id', invoice.id);
                
                if (!error) {
                    await loadInvoices();
                    setPaymentModal(null);
                }
            };
            
            const deleteInvoice = async (inv) => {
                if (!confirm('Delete invoice ' + inv.invoiceNumber + '?')) return;
                const { error } = await supabase.from('invoices').delete().eq('id', inv.id);
                if (!error) await loadInvoices();
            };
            
            const calcLine = (item) => {
                const r = parseFloat(item.rate)||0, q = parseFloat(item.qty)||0, d = parseFloat(item.discount)||0;
                let finalRate = r - (r * d / 100);
                
                if(taxInc) {
                    // Tax included: rate entered is final price with GST
                    // Calculate backwards: base = rate * 100/105
                    const base = finalRate * 100 / 105;
                    const gst = finalRate - base;
                    return {
                        base: (base * q).toFixed(2),
                        cgst: ((gst / 2) * q).toFixed(2),
                        sgst: ((gst / 2) * q).toFixed(2),
                        tot: (finalRate * q).toFixed(2),
                        unitBase: base.toFixed(2)
                    };
                }
                
                // Normal bill: No GST calculation
                return {
                    base: (finalRate * q).toFixed(2),
                    cgst: '0.00',
                    sgst: '0.00',
                    tot: (finalRate * q).toFixed(2),
                    unitBase: finalRate.toFixed(2)
                };
            };
            
            const calcTotals = () => {
                let sub=0,cg=0,sg=0,tq=0,ti=items.filter(i=>i.name).length;
                items.forEach(i=>{
                    if(i.name){
                        const c=calcLine(i);
                        sub+=parseFloat(c.base);
                        cg+=parseFloat(c.cgst);
                        sg+=parseFloat(c.sgst);
                        tq+=parseFloat(i.qty)||0;
                    }
                });
                
                const discAmt = (sub * (parseFloat(discount)||0) / 100);
                const afterDisc = sub - discAmt;
                
                let cgstFinal, sgstFinal, gt;
                if(taxInc) {
                    // Tax bill: GST already calculated in items
                    cgstFinal = (afterDisc * 0.025);
                    sgstFinal = (afterDisc * 0.025);
                    gt = afterDisc + cgstFinal + sgstFinal;
                } else {
                    // Normal bill: No GST
                    cgstFinal = 0;
                    sgstFinal = 0;
                    gt = afterDisc;
                }
                
                return {
                    sub:sub.toFixed(2),
                    discAmt:discAmt.toFixed(2),
                    afterDisc:afterDisc.toFixed(2),
                    cg:cgstFinal.toFixed(2),
                    sg:sgstFinal.toFixed(2),
                    gt:gt.toFixed(2),
                    tq,
                    ti,
                    words:numberToWords(gt)
                };
            };
            
            const tots = calcTotals();
            
            if (loading || !config) {
                return h('div', { className: 'min-h-screen flex items-center justify-center' },
                    h('div', { className: 'loader' })
                );
            }
            
            const NavButton = ({icon, label, viewName}) => 
                h('button', {
                    onClick: () => setView(viewName),
                    className: `flex items-center gap-2 px-4 py-2 rounded-lg transition ${view === viewName ? 'gradient-bg text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}`
                }, icon, ' ', label);
            
            return h('div',{className:'no-print min-h-screen bg-gray-50'},
                // Top Navigation
                h('div',{className:'gradient-bg text-white shadow-xl'},
                    h('div',{className:'container mx-auto px-6 py-4'},
                        h('div',{className:'flex items-center justify-between'},
                            h('div',{className:'flex items-center gap-3'},
                                h('div',{className:'text-3xl'},'ðŸ’¼'),
                                h('h1',{className:'text-2xl font-bold'},'Smart GST Billing')
                            ),
                            h('div',{className:'flex items-center gap-4'},
                                h('span',{className:'text-sm bg-white bg-opacity-20 px-3 py-1 rounded-full'}, user.email),
                                h('button',{onClick:()=>setShowChatbot(!showChatbot),className:'bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition'},'ðŸ¤– AI Assistant'),
                                h('button',{onClick:onLogout,className:'bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition'},'Logout')
                            )
                        )
                    )
                ),
                
                // Side Navigation
                h('div',{className:'container mx-auto px-6 py-6'},
                    h('div',{className:'flex gap-4 mb-6 overflow-x-auto pb-2'},
                        h(NavButton, {icon:'ðŸ“Š', label:'Dashboard', viewName:'dashboard'}),
                        h(NavButton, {icon:'ðŸ“', label:'Invoice', viewName:'invoice'}),
                        h(NavButton, {icon:'ðŸ“¦', label:'Products', viewName:'stock'}),
                        h(NavButton, {icon:'ðŸ“œ', label:'History', viewName:'history'}),
                        h(NavButton, {icon:'âš™ï¸', label:'Settings', viewName:'settings'})
                    ),
                    
                    // Main Content
                    view==='dashboard' ? h(Dashboard, {invoices:invs, customers:custs, products:prods}) :
                    view==='settings'?h('div',{className:'bg-white rounded-xl shadow-lg p-8'},
                        h('h2',{className:'text-3xl font-bold mb-6 gradient-text'},'âš™ï¸ Settings'),
                        
                        // Business Settings Section
                        h('div',{className:'mb-12'},
                            h('h3',{className:'text-2xl font-bold mb-4 text-gray-800'},'Business Information'),
                            h('div',{className:'max-w-3xl space-y-6'},
                                h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Business Name'),h('input',{type:'text',value:config.name,onChange:e=>setConfig({...config,name:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})),
                                h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Address'),h('textarea',{value:config.address,onChange:e=>setConfig({...config,address:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',rows:3})),
                                h('div',{className:'grid grid-cols-2 gap-6'},
                                    h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'GSTIN'),h('input',{type:'text',value:config.gstin,onChange:e=>setConfig({...config,gstin:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})),
                                    h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Phone'),h('input',{type:'text',value:config.phone,onChange:e=>setConfig({...config,phone:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'}))
                                ),
                                h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Email'),h('input',{type:'email',value:config.email,onChange:e=>setConfig({...config,email:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})),
                                h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Bank Name'),h('input',{type:'text',value:config.bankName,onChange:e=>setConfig({...config,bankName:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})),
                                h('div',{className:'grid grid-cols-2 gap-6'},
                                    h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Account No'),h('input',{type:'text',value:config.accountNo,onChange:e=>setConfig({...config,accountNo:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})),
                                    h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'IFSC'),h('input',{type:'text',value:config.ifsc,onChange:e=>setConfig({...config,ifsc:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'}))
                                ),
                                h('button',{onClick:saveProfile,className:'gradient-bg text-white px-8 py-3 rounded-lg hover:opacity-90 transition font-semibold text-lg'},'ðŸ’¾ Save Business Settings')
                            )
                        ),
                        
                        // Categories Section
                        h('div',{className:'border-t-2 pt-8'},
                            h('div',{className:'flex justify-between items-center mb-4'},
                                h('h3',{className:'text-2xl font-bold text-gray-800'},'Bill Categories'),
                                h('button',{onClick:()=>{setShowCategoryForm(true);setEditingCategory(null);setCategoryFormData({name:'',description:'',default_hsn:'33074100',has_mrp:false})},className:'bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition font-semibold'},'âž• Add Category')
                            ),
                            showCategoryForm&&h('div',{className:'mb-6 p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl'},
                                h('h4',{className:'font-bold mb-4 text-lg'},(editingCategory?'Edit':'Add')+' Category'),
                                h('div',{className:'space-y-4'},
                                    h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Category Name'),h('input',{type:'text',value:categoryFormData.name,onChange:e=>setCategoryFormData({...categoryFormData,name:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',placeholder:'e.g., Retail Bills, Wholesale Bills'})),
                                    h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Description (Optional)'),h('textarea',{value:categoryFormData.description,onChange:e=>setCategoryFormData({...categoryFormData,description:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',rows:2,placeholder:'Brief description of this category'})),
                                    h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Default HSN Code'),h('input',{type:'text',value:categoryFormData.default_hsn,onChange:e=>setCategoryFormData({...categoryFormData,default_hsn:e.target.value}),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',placeholder:'33074100'})),
                                    h('div',{className:'flex items-center gap-3'},
                                        h('label',{className:'font-semibold text-gray-700'},'Has MRP Column'),
                                        h('input',{type:'checkbox',checked:categoryFormData.has_mrp,onChange:e=>setCategoryFormData({...categoryFormData,has_mrp:e.target.checked}),className:'w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500'})
                                    ),
                                    h('div',{className:'flex gap-3'},
                                        h('button',{onClick:saveCategory,className:'gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition font-semibold'},'ðŸ’¾ Save'),
                                        h('button',{onClick:()=>{setShowCategoryForm(false);setEditingCategory(null);setCategoryFormData({name:'',description:'',default_hsn:'33074100',has_mrp:false})},className:'bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition font-semibold'},'Cancel')
                                    )
                                )
                            ),
                            h('div',{className:'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'},
                                categories.map(cat=>
                                    h('div',{key:cat.id,className:'bg-white border-2 border-gray-200 rounded-xl p-4 hover:border-purple-500 transition'},
                                        h('div',{className:'flex justify-between items-start mb-2'},
                                            h('h4',{className:'font-bold text-lg text-gray-800'},cat.name),
                                            h('div',{className:'flex gap-2'},
                                                h('button',{onClick:()=>{setEditingCategory(cat);setCategoryFormData({name:cat.name,description:cat.description||'',default_hsn:cat.default_hsn||'33074100',has_mrp:cat.has_mrp||false});setShowCategoryForm(true)},className:'text-blue-500 hover:text-blue-700 font-bold'},'âœŽ'),
                                                h('button',{onClick:()=>deleteCategory(cat.id),className:'text-red-500 hover:text-red-700 font-bold'},'âœ•')
                                            )
                                        ),
                                        cat.description&&h('p',{className:'text-gray-600 text-sm mb-2'},cat.description),
                                        h('div',{className:'flex gap-2 text-xs'},
                                            h('span',{className:'bg-gray-100 text-gray-700 px-2 py-1 rounded'},'HSN: '+cat.default_hsn),
                                            cat.has_mrp&&h('span',{className:'bg-green-100 text-green-700 px-2 py-1 rounded'},'Has MRP')
                                        )
                                    )
                                )
                            )
                        )
                    ):view==='invoice'?(!selectedCategory?h('div',{className:'bg-white rounded-xl shadow-lg p-8'},
                        h('h2',{className:'text-3xl font-bold mb-6 gradient-text'},'ðŸ“ Select Bill Category'),
                        categories.length===0?h('div',{className:'text-center py-12'},
                            h('p',{className:'text-gray-600 mb-4'},'No categories found. Please add categories in Settings.'),
                            h('button',{onClick:()=>setView('settings'),className:'gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition font-semibold'},'Go to Settings')
                        ):h('div',{className:'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'},
                            categories.map(cat=>
                                h('div',{key:cat.id,onClick:()=>{setSelectedCategory(cat);setItems([{id:Date.now(),name:'',hsn:cat.default_hsn||'33074100',qty:1,unit:'Pcs',rate:0,mrp:0,freeQty:0,freeUnit:'Pcs',discount:0}])},className:'bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl shadow-lg p-6 cursor-pointer card-hover border-2 border-transparent hover:border-purple-500 transition'},
                                    h('div',{className:'text-4xl mb-3'},'ðŸ“‹'),
                                    h('h3',{className:'text-xl font-bold text-gray-800 mb-2'},cat.name),
                                    cat.description&&h('p',{className:'text-gray-600 text-sm mb-3'},cat.description),
                                    h('div',{className:'flex gap-2 text-xs'},
                                        h('span',{className:'bg-purple-100 text-purple-700 px-2 py-1 rounded'},'HSN: '+cat.default_hsn),
                                        cat.has_mrp&&h('span',{className:'bg-green-100 text-green-700 px-2 py-1 rounded'},'Has MRP')
                                    )
                                )
                            )
                        )
                    ):h('div',{className:'bg-white rounded-xl shadow-lg p-8'},
                        h('div',{className:'flex justify-between items-center mb-6 pb-6 border-b-2'},
                            h('div',{},
                                h('div',{className:'flex items-center gap-3 mb-2'},
                                    h('button',{onClick:()=>{setSelectedCategory(null);setItems([{id:Date.now(),name:'',hsn:'33074100',qty:1,unit:'Pcs',rate:0,mrp:0,freeQty:0,freeUnit:'Pcs',discount:0}])},className:'text-gray-500 hover:text-gray-700 transition'},'â† Back'),
                                    h('h3',{className:'text-xl font-bold gradient-text'},selectedCategory.name)
                                ),
                                h('div',{className:'flex gap-4'},
                                    h('button',{onClick:async()=>{await generateNextInvoiceNumber();setInvDate(getCurrentDate());setCustName('');setCustAddr('');setCustGST('');setCustPhone('');setItems([{id:Date.now(),name:'',hsn:selectedCategory.default_hsn||'33074100',qty:1,unit:'Pcs',rate:0,mrp:0,freeQty:0,freeUnit:'Pcs',discount:0}]);setDiscount(0)},className:'bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition font-semibold'},'ðŸ†• New'),
                                    h('button',{onClick:saveInvoice,className:'gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition font-semibold'},'ðŸ’¾ Save'),
                                    items.filter(i=>i.name).length>0&&h('button',{onClick:()=>window.print(),className:'bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition font-semibold'},'ðŸ–¨ Print')
                                )
                            ),
                            h('div',{className:'flex items-center gap-3'},
                                h('label',{className:'font-semibold text-gray-700'},taxInc?'Tax Bill':'Normal Bill'),
                                h('button',{onClick:()=>setTaxInc(!taxInc),className:`relative inline-flex h-10 w-20 items-center rounded-full transition ${taxInc?'bg-green-500':'bg-gray-300'}`},h('span',{className:`inline-block h-8 w-8 rounded-full bg-white transform transition ${taxInc?'translate-x-11':'translate-x-1'}`})),
                                h('span',{className:'font-bold'},taxInc?'ON':'OFF')
                            )
                        ),
                        h('div',{className:'grid grid-cols-2 gap-6 mb-6'},
                            h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Invoice #'),h('input',{type:'text',value:invNum,onChange:e=>setInvNum(e.target.value),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})),
                            h('div',{},h('label',{className:'block font-semibold mb-2 text-gray-700'},'Date'),h('input',{type:'date',value:invDate,onChange:e=>setInvDate(e.target.value),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'}))
                        ),
                        h('div',{className:'mb-6 p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl'},
                            h('h3',{className:'font-bold mb-4 text-lg text-gray-800'},'Customer Details'),
                            h('div',{className:'relative mb-3'},
                                h('input',{type:'text',placeholder:'Customer Name',value:custName,onChange:e=>{setCustName(e.target.value);const c=custs.find(x=>x.name===e.target.value);if(c){setCustAddr(c.address);setCustGST(c.gstin);setCustPhone(c.phone||'')}},className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'}),
                                custName&&!custs.find(c=>c.name===custName)&&custs.filter(c=>c.name.toLowerCase().includes(custName.toLowerCase())).length>0&&
                                h('div',{className:'absolute z-[9999] w-full bg-white border-2 border-purple-200 rounded-lg shadow-xl max-h-48 overflow-y-auto mt-1'},
                                    custs.filter(c=>c.name.toLowerCase().includes(custName.toLowerCase())).map((c,i)=>
                                        h('div',{key:i,onClick:()=>{setCustName(c.name);setCustAddr(c.address);setCustGST(c.gstin);setCustPhone(c.phone||'')},className:'px-4 py-3 hover:bg-purple-50 cursor-pointer border-b transition'},c.name)
                                    )
                                )
                            ),
                            h('textarea',{placeholder:'Address',value:custAddr,onChange:e=>setCustAddr(e.target.value),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',rows:2}),
                            h('div',{className:'grid grid-cols-2 gap-3'},
                                h('input',{type:'text',placeholder:'GSTIN',value:custGST,onChange:e=>setCustGST(e.target.value),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'}),
                                h('input',{type:'text',placeholder:'Phone',value:custPhone,onChange:e=>setCustPhone(e.target.value),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})
                            )
                        ),
                        h('div',{className:'mb-6'},
                            h('h3',{className:'font-bold mb-4 text-lg text-gray-800'},'Invoice Items'),
                            h('div',{className:'overflow-x-auto'},
                                h('table',{className:'w-full border-collapse'},
                                    h('thead',{},h('tr',{className:'gradient-bg text-white'},
                                        h('th',{className:'border border-gray-300 p-3 text-left'},'#'),
                                        h('th',{className:'border border-gray-300 p-3 text-left'},'Item'),
                                        selectedCategory?.has_mrp&&h('th',{className:'border border-gray-300 p-3 text-left'},'MRP'),
                                        h('th',{className:'border border-gray-300 p-3 text-left'},'Qty'),
                                        h('th',{className:'border border-gray-300 p-3 text-left'},'Unit'),
                                        h('th',{className:'border border-gray-300 p-3 text-left'},'Free'),
                                        h('th',{className:'border border-gray-300 p-3 text-left'},'Rate'),
                                        h('th',{className:'border border-gray-300 p-3 text-left'},'Disc%'),
                                        h('th',{className:'border border-gray-300 p-3 text-right'},'Total'),
                                        h('th',{className:'border border-gray-300 p-3 text-center'},'X')
                                    )),
                                    h('tbody',{},items.map((it,idx)=>{const c=calcLine(it);return h('tr',{key:it.id,className:'hover:bg-purple-50 transition'},
                                        h('td',{className:'border border-gray-300 p-3 font-semibold'},idx+1),
                                        h('td',{className:'border border-gray-300 p-3 relative'},
                                            h('input',{type:'text',value:it.name,onChange:e=>{const v=e.target.value;setItems(items.map(i=>i.id===it.id?{...i,name:v}:i));const p=prods.find(x=>x.name===v);if(p){setItems(items.map(i=>i.id===it.id?{...i,name:p.name,rate:p.rate}:i))}},className:'w-full px-3 py-2 border-2 border-gray-200 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'}),
                                            it.name&&!prods.find(p=>p.name===it.name)&&prods.filter(p=>p.name.toLowerCase().includes(it.name.toLowerCase())).length>0&&
                                            h('div',{className:'absolute z-[9999] w-80 bg-white border-2 border-purple-200 rounded-lg shadow-xl max-h-48 overflow-y-auto top-full left-0 mt-1'},
                                                prods.filter(p=>p.name.toLowerCase().includes(it.name.toLowerCase())).map((p,i)=>
                                                    h('div',{key:i,onClick:()=>setItems(items.map(im=>im.id===it.id?{...im,name:p.name,rate:p.rate}:im)),className:'px-4 py-3 hover:bg-purple-50 cursor-pointer border-b transition'},p.name+' - â‚¹'+p.rate)
                                                )
                                            )
                                        ),
                                        selectedCategory?.has_mrp&&h('td',{className:'border border-gray-300 p-3'},h('input',{type:'number',value:it.mrp||0,onChange:e=>setItems(items.map(i=>i.id===it.id?{...i,mrp:e.target.value}:i)),className:'w-24 px-3 py-2 border-2 border-gray-200 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',step:0.01,placeholder:'MRP'})),
                                        h('td',{className:'border border-gray-300 p-3'},h('input',{type:'number',value:it.qty,onChange:e=>setItems(items.map(i=>i.id===it.id?{...i,qty:e.target.value}:i)),className:'w-24 px-3 py-2 border-2 border-gray-200 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})),
                                        h('td',{className:'border border-gray-300 p-3'},h('select',{value:it.unit,onChange:e=>setItems(items.map(i=>i.id===it.id?{...i,unit:e.target.value}:i)),className:'w-full px-3 py-2 border-2 border-gray-200 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'},h('option',{value:'Pcs'},'Pcs'),h('option',{value:'Dozen'},'Dozen'),h('option',{value:'Gross'},'Gross'),h('option',{value:'Kg'},'Kg'),h('option',{value:'Ltr'},'Ltr'))),
                                        h('td',{className:'border border-gray-300 p-3'},
                                            h('div',{className:'flex gap-1'},
                                                h('input',{type:'number',value:it.freeQty||0,onChange:e=>setItems(items.map(i=>i.id===it.id?{...i,freeQty:e.target.value}:i)),className:'w-16 px-2 py-2 border-2 border-gray-200 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'}),
                                                h('select',{value:it.freeUnit||'Pcs',onChange:e=>setItems(items.map(i=>i.id===it.id?{...i,freeUnit:e.target.value}:i)),className:'w-20 px-2 py-2 border-2 border-gray-200 rounded text-xs focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'},h('option',{value:'Pcs'},'Pcs'),h('option',{value:'Dnz'},'Dnz'),h('option',{value:'Grs'},'Grs'))
                                            )
                                        ),
                                        h('td',{className:'border border-gray-300 p-3'},
                                            h('div',{className:'flex flex-col gap-1'},
                                                h('input',{type:'number',value:it.rate,onChange:e=>setItems(items.map(i=>i.id===it.id?{...i,rate:e.target.value}:i)),className:'w-28 px-3 py-2 border-2 border-gray-200 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',step:0.01,placeholder:taxInc?'Final Price':'Rate'}),
                                                taxInc&&parseFloat(it.rate)>0&&h('span',{className:'text-xs text-gray-500'},'Base: â‚¹'+c.unitBase)
                                            )
                                        ),
                                        h('td',{className:'border border-gray-300 p-3'},h('input',{type:'number',value:it.discount||0,onChange:e=>setItems(items.map(i=>i.id===it.id?{...i,discount:e.target.value}:i)),className:'w-20 px-3 py-2 border-2 border-gray-200 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',step:0.01,min:0,max:100})),
                                        h('td',{className:'border border-gray-300 p-3 text-right font-bold text-purple-600'},'â‚¹'+c.tot),
                                        h('td',{className:'border border-gray-300 p-3 text-center'},h('button',{onClick:()=>items.length>1&&setItems(items.filter(i=>i.id!==it.id)),className:'text-red-500 hover:text-red-700 font-bold text-xl transition',disabled:items.length===1},'âœ•'))
                                    )}))
                                )
                            ),
                            h('button',{onClick:()=>setItems([...items,{id:Date.now(),name:'',hsn:selectedCategory?.default_hsn||'33074100',qty:1,unit:'Pcs',rate:0,mrp:0,freeQty:0,freeUnit:'Pcs',discount:0}]),className:'mt-4 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition font-semibold'},'âž• Add Item')
                        ),
                        h('div',{className:'grid grid-cols-2 gap-6'},
                            h('div',{className:'p-6 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl'},
                                h('h3',{className:'font-bold mb-3 text-lg text-gray-800'},'Overall Discount %'),
                                h('input',{type:'number',value:discount,onChange:e=>setDiscount(e.target.value),className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition text-xl',step:0.01,min:0,max:100,placeholder:'0'})
                            ),
                            h('div',{className:'p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl'},
                                h('h3',{className:'font-bold mb-3 text-lg text-gray-800'},'Totals'),
                                h('p',{className:'text-gray-700 mb-1'},'Subtotal: ',h('span',{className:'font-bold'},'â‚¹'+tots.sub)),
                                parseFloat(discount)>0&&h('p',{className:'text-gray-700 mb-1'},'Discount (',discount,'%): ',h('span',{className:'font-bold text-red-600'},'-â‚¹'+tots.discAmt)),
                                parseFloat(discount)>0&&h('p',{className:'text-gray-700 mb-1'},'After Discount: ',h('span',{className:'font-bold'},'â‚¹'+tots.afterDisc)),
                                h('p',{className:'text-gray-700 mb-1'},'CGST (2.5%): ',h('span',{className:'font-bold'},'â‚¹'+tots.cg)),
                                h('p',{className:'text-gray-700 mb-1'},'SGST (2.5%): ',h('span',{className:'font-bold'},'â‚¹'+tots.sg)),
                                h('p',{className:'text-2xl font-bold text-purple-600 mt-2'},'â‚¹'+tots.gt),
                                h('p',{className:'text-xs text-gray-600 mt-2'},tots.words)
                            )
                        )
                    )):view==='stock'?h('div',{className:'bg-white rounded-xl shadow-lg p-8'},
                        h('div',{className:'flex justify-between mb-6'},
                            h('h2',{className:'text-3xl font-bold gradient-text'},'Product Rates'),
                            h('button',{onClick:()=>{setShowStockForm(true);setStockFormData({name:'',rate:0})},className:'bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition font-semibold'},'âž• Add Product')
                        ),
                        showStockForm&&h('div',{className:'mb-6 p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border-2 border-purple-200'},
                            h('h3',{className:'font-bold mb-4 text-lg text-gray-800'},'Add New Product'),
                            h('div',{className:'grid grid-cols-2 gap-4 mb-4'},
                                h('input',{type:'text',placeholder:'Product Name',value:stockFormData.name,onChange:e=>setStockFormData({...stockFormData,name:e.target.value}),className:'px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'}),
                                h('input',{type:'number',placeholder:'Rate',value:stockFormData.rate,onChange:e=>setStockFormData({...stockFormData,rate:e.target.value}),className:'px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',step:0.01})
                            ),
                            h('div',{className:'flex gap-3'},
                                h('button',{onClick:async()=>{if(stockFormData.name){const {error}=await supabase.from('product_rates').upsert({user_id:user.id,name:stockFormData.name,rate:parseFloat(stockFormData.rate)||0},{onConflict:'user_id,name'});if(!error){await loadProducts();setShowStockForm(false);setStockFormData({name:'',rate:0})}}},className:'gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition font-semibold'},'Save'),
                                h('button',{onClick:()=>{setShowStockForm(false);setStockFormData({name:'',rate:0})},className:'bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition font-semibold'},'Cancel')
                            )
                        ),
                        stock.length===0?h('p',{className:'text-center py-16 text-gray-500 text-lg'},'No products added yet'):
                        h('div',{className:'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'},
                            stock.map((s,i)=>h('div',{key:i,className:'p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl card-hover border-2 border-gray-100'},
                                editingStock===i?
                                h('div',{className:'space-y-3'},
                                    h('input',{type:'text',value:s.name,onChange:e=>{const ns=stock.map((st,idx)=>idx===i?{...st,name:e.target.value}:st);setStock(ns)},className:'w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'}),
                                    h('input',{type:'number',value:s.rate||0,onChange:e=>{const ns=stock.map((st,idx)=>idx===i?{...st,rate:e.target.value}:st);setStock(ns)},className:'w-full px-4 py-2 border-2 border-gray-200 rounded-lg text-right focus:ring-2 focus:ring-purple-500 focus:border-transparent transition',step:0.01}),
                                    h('div',{className:'flex gap-2'},
                                        h('button',{onClick:async()=>{await supabase.from('product_rates').update({name:stock[i].name,rate:parseFloat(stock[i].rate)}).eq('id',s.id);await loadProducts();setEditingStock(null)},className:'flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition font-semibold'},'âœ“'),
                                        h('button',{onClick:async()=>{await loadProducts();setEditingStock(null)},className:'flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition font-semibold'},'âœ•')
                                    )
                                ):
                                h('div',{},
                                    h('h3',{className:'text-xl font-bold text-gray-800 mb-2'},s.name),
                                    h('p',{className:'text-3xl font-bold text-purple-600 mb-4'},'â‚¹'+(s.rate||0)),
                                    h('div',{className:'flex gap-2'},
                                        h('button',{onClick:()=>setEditingStock(i),className:'flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition font-semibold'},'Edit'),
                                        h('button',{onClick:async()=>{if(confirm('Delete '+s.name+'?')){await supabase.from('product_rates').delete().eq('id',s.id);await loadProducts()}},className:'flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition font-semibold'},'Delete')
                                    )
                                )
                            ))
                        )
                    ):h('div',{className:'bg-white rounded-xl shadow-lg p-8'},
                        h('div',{className:'mb-6'},
                            h('h2',{className:'text-3xl font-bold mb-6 gradient-text'},'ðŸ“œ Invoice History'),
                            h('div',{className:'mb-4'},
                                h('input',{type:'text',placeholder:'ðŸ” Search by invoice # or customer name...',value:searchQuery,onChange:e=>setSearchQuery(e.target.value),className:'w-full px-6 py-4 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition text-lg'})
                            ),
                            h('div',{className:'flex items-center gap-4 mb-4 flex-wrap'},
                                h('div',{},h('label',{className:'block text-sm font-semibold mb-2 text-gray-700'},'Category'),h('select',{value:categoryFilter,onChange:e=>setCategoryFilter(e.target.value),className:'px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'},h('option',{value:''},'All Categories'),categories.map(cat=>h('option',{key:cat.id,value:cat.id},cat.name)))),
                                h('div',{},h('label',{className:'block text-sm font-semibold mb-2 text-gray-700'},'From Date'),h('input',{type:'date',value:fromDate,onChange:e=>setFromDate(e.target.value),className:'px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})),
                                h('div',{},h('label',{className:'block text-sm font-semibold mb-2 text-gray-700'},'To Date'),h('input',{type:'date',value:toDate,onChange:e=>setToDate(e.target.value),className:'px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})),
                                h('button',{onClick:()=>{setFromDate('');setToDate('');setSearchQuery('');setCategoryFilter('')},className:'bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg mt-6 transition font-semibold'},'Clear Filters')
                            )
                        ),
                        invs.filter(inv=>{const d=inv.date;const matchesDate=(!fromDate||d>=fromDate)&&(!toDate||d<=toDate);const matchesSearch=!searchQuery||inv.invoiceNumber.toLowerCase().includes(searchQuery.toLowerCase())||inv.customer.name.toLowerCase().includes(searchQuery.toLowerCase());const matchesCategory=!categoryFilter||inv.category_id==categoryFilter;return matchesDate&&matchesSearch&&matchesCategory;}).length===0?h('p',{className:'text-center py-16 text-gray-500 text-lg'},'No invoices found'):
                        h('div',{className:'overflow-x-auto'},
                            h('table',{className:'w-full border-collapse'},
                                h('thead',{},h('tr',{className:'gradient-bg text-white'},h('th',{className:'border border-gray-300 p-4 text-left'},'Invoice #'),h('th',{className:'border border-gray-300 p-4 text-left'},'Date'),h('th',{className:'border border-gray-300 p-4 text-left'},'Customer'),h('th',{className:'border border-gray-300 p-4 text-left'},'Category'),h('th',{className:'border border-gray-300 p-4 text-right'},'Amount'),h('th',{className:'border border-gray-300 p-4 text-center'},'Status'),h('th',{className:'border border-gray-300 p-4 text-center'},'Actions'))),
                                h('tbody',{},invs.filter(inv=>{const d=inv.date;const matchesDate=(!fromDate||d>=fromDate)&&(!toDate||d<=toDate);const matchesSearch=!searchQuery||inv.invoiceNumber.toLowerCase().includes(searchQuery.toLowerCase())||inv.customer.name.toLowerCase().includes(searchQuery.toLowerCase());const matchesCategory=!categoryFilter||inv.category_id==categoryFilter;return matchesDate&&matchesSearch&&matchesCategory;}).map((inv,i)=>h('tr',{key:i,className:'hover:bg-purple-50 transition'},
                                    h('td',{className:'border border-gray-300 p-4 font-bold text-purple-600'},inv.invoiceNumber),
                                    h('td',{className:'border border-gray-300 p-4'},inv.date),
                                    h('td',{className:'border border-gray-300 p-4'},inv.customer.name),
                                    h('td',{className:'border border-gray-300 p-4'},h('span',{className:'bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-medium'},inv.category?.name||'N/A')),
                                    h('td',{className:'border border-gray-300 p-4 text-right font-bold'},'â‚¹'+inv.totals.gt),
                                    h('td',{className:'border border-gray-300 p-4 text-center'},
                                        h('span',{className:`status-badge status-${inv.payment_status}`},
                                            inv.payment_status === 'paid' ? 'âœ… Paid' :
                                            inv.payment_status === 'partial' ? 'â³ Partial' : 'âš ï¸ Unpaid'
                                        ),
                                        inv.payment_status === 'partial' && 
                                        h('div',{className:'text-xs mt-1 text-gray-600'},'Paid: â‚¹'+inv.amount_paid+' / Pending: â‚¹'+(parseFloat(inv.totals.gt) - parseFloat(inv.amount_paid)).toFixed(2))
                                    ),
                                    h('td',{className:'border border-gray-300 p-4'},
                                        h('div',{className:'flex gap-2 justify-center flex-wrap'},
                                            h('button',{onClick:()=>{setInvNum(inv.invoiceNumber);setInvDate(inv.date);setCustName(inv.customer.name);setCustAddr(inv.customer.address);setCustGST(inv.customer.gstin);setCustPhone(inv.customer.phone||'');setItems(inv.items.map((it,idx)=>({...it,id:idx+1})));setTaxInc(inv.taxInclusive);setDiscount(inv.discount||0);setSelectedCategory(inv.category);setView('invoice');setTimeout(()=>window.print(),100)},className:'bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm transition font-semibold'},'ðŸ–¨ Print'),
                                            h('button',{onClick:()=>setPaymentModal(inv),className:'bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm transition font-semibold'},'ðŸ’³ Payment'),
                                            h('button',{onClick:()=>deleteInvoice(inv),className:'bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm transition font-semibold'},'ðŸ—‘ Delete')
                                        )
                                    )
                                )))
                            )
                        )
                    )
                ),
                
                // Payment Modal
                paymentModal && h('div',{className:'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4'},
                    h('div',{className:'bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full'},
                        h('h3',{className:'text-2xl font-bold mb-4 gradient-text'},'Payment for '+paymentModal.invoiceNumber),
                        h('p',{className:'mb-2'},'Customer: ',h('span',{className:'font-bold'},paymentModal.customer.name)),
                        h('p',{className:'mb-2'},'Total Amount: ',h('span',{className:'font-bold text-purple-600'},'â‚¹'+paymentModal.totals.gt)),
                        h('p',{className:'mb-6'},'Already Paid: ',h('span',{className:'font-bold text-green-600'},'â‚¹'+(paymentModal.amount_paid||0))),
                        h('div',{className:'space-y-4'},
                            h('div',{},
                                h('label',{className:'block font-semibold mb-2 text-gray-700'},'Payment Status'),
                                h('select',{id:'payment-status',className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'},
                                    h('option',{value:'paid'},'âœ… Paid'),
                                    h('option',{value:'partial'},'â³ Partially Paid'),
                                    h('option',{value:'unpaid'},'âš ï¸ Unpaid')
                                )
                            ),
                            h('div',{},
                                h('label',{className:'block font-semibold mb-2 text-gray-700'},'Amount Paid'),
                                h('input',{type:'number',id:'amount-paid',defaultValue:paymentModal.amount_paid||0,step:0.01,className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})
                            ),
                            h('div',{},
                                h('label',{className:'block font-semibold mb-2 text-gray-700'},'Payment Notes (optional)'),
                                h('input',{type:'text',id:'payment-notes',placeholder:'e.g., Transaction ID, Payment method',className:'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition'})
                            ),
                            h('div',{className:'flex gap-3 mt-6'},
                                h('button',{onClick:()=>{
                                    const status=document.getElementById('payment-status').value;
                                    const amount=document.getElementById('amount-paid').value;
                                    const notes=document.getElementById('payment-notes').value;
                                    updatePaymentStatus(paymentModal,status,amount,notes);
                                },className:'flex-1 gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition font-semibold'},'Save'),
                                h('button',{onClick:()=>setPaymentModal(null),className:'flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition font-semibold'},'Cancel')
                            )
                        )
                    )
                ),
                
                // AI Chatbot Sidebar
                showChatbot && h('div',{className:'fixed right-0 top-0 w-96 h-screen bg-white shadow-2xl z-40 flex flex-col'},
                    h('div',{className:'gradient-bg text-white p-4 flex items-center justify-between'},
                        h('h3',{className:'text-xl font-bold'},'ðŸ¤– AI Assistant'),
                        h('button',{onClick:()=>setShowChatbot(false),className:'text-white hover:text-gray-200 text-2xl'},'âœ•')
                    ),
                    h(AIChatbot, {invoices:invs, customers:custs, products:prods, user})
                ),
                
                // Print Container
                h('div',{className:'print-container'},
                    h('div',{className:'print-header'},
                        h('div',{style:{display:'flex',justifyContent:'space-between',marginBottom:'20px'}},
                            h('div',{},h('h1',{style:{fontSize:'24px',fontWeight:'bold',margin:'0 0 10px 0'}},config.name),h('p',{style:{margin:'2px 0',fontSize:'12px'}},config.address),h('p',{style:{margin:'2px 0',fontSize:'12px'}},'GSTIN: '+config.gstin),h('p',{style:{margin:'2px 0',fontSize:'12px'}},'Phone: '+config.phone),h('p',{style:{margin:'2px 0',fontSize:'12px'}},'Email: '+config.email)),
                            h('div',{style:{textAlign:'right'}},h('h2',{style:{fontSize:'20px',fontWeight:'bold',margin:'0 0 10px 0'}},taxInc?'TAX INVOICE':'INVOICE'),h('p',{style:{margin:'2px 0',fontSize:'12px'}},h('strong',{},'Invoice #: '),invNum),h('p',{style:{margin:'2px 0',fontSize:'12px'}},h('strong',{},'Date: '),invDate))
                        ),
                        h('div',{style:{marginBottom:'20px',padding:'10px',border:'1px solid #000'}},h('h3',{style:{fontSize:'14px',fontWeight:'bold',margin:'0 0 5px 0'}},'Bill To:'),h('p',{style:{margin:'2px 0',fontSize:'12px'}},h('strong',{},custName)),h('p',{style:{margin:'2px 0',fontSize:'12px'}},custAddr),custPhone&&h('p',{style:{margin:'2px 0',fontSize:'12px'}},'Phone: '+custPhone),custGST&&h('p',{style:{margin:'2px 0',fontSize:'12px'}},'GSTIN: '+custGST))
                    ),
                    h('table',{className:'invoice-table'},
                        h('thead',{},h('tr',{},h('th',{style:{width:'4%'}},'#'),h('th',{style:{width:'25%'}},'Item'),h('th',{style:{width:'9%'}},'HSN'),h('th',{style:{width:'7%'}},'Qty'),h('th',{style:{width:'7%'}},'Unit'),h('th',{style:{width:'10%'}},'Free'),h('th',{style:{width:'11%',textAlign:'right'}},'Rate'),h('th',{style:{width:'12%',textAlign:'right'}},'Taxable'),h('th',{style:{width:'15%',textAlign:'right'}},'Total'))),
                        h('tbody',{},
                            items.filter(i=>i.name).map((it,idx)=>{const c=calcLine(it);const freeText=(it.freeQty&&parseFloat(it.freeQty)>0)?`${it.freeQty} ${it.freeUnit||'Pcs'}`:'';const discText=(it.discount&&parseFloat(it.discount)>0)?` (${it.discount}% off)`:'';return h('tr',{key:it.id},h('td',{},idx+1),h('td',{},it.name+discText),h('td',{},it.hsn),h('td',{},it.qty),h('td',{},it.unit),h('td',{},freeText),h('td',{style:{textAlign:'right'}},'â‚¹'+(taxInc?c.unitBase:it.rate)),h('td',{style:{textAlign:'right'}},'â‚¹'+c.base),h('td',{style:{textAlign:'right'}},'â‚¹'+c.tot))}),
                            h('tr',{},h('td',{colSpan:7,style:{textAlign:'right',fontWeight:'bold'}},'Subtotal:'),h('td',{colSpan:2,style:{textAlign:'right',fontWeight:'bold'}},'â‚¹'+tots.sub)),
                            parseFloat(discount)>0&&h('tr',{},h('td',{colSpan:7,style:{textAlign:'right'}},'Discount ('+discount+'%):'),h('td',{colSpan:2,style:{textAlign:'right'}},'-â‚¹'+tots.discAmt)),
                            parseFloat(discount)>0&&h('tr',{},h('td',{colSpan:7,style:{textAlign:'right',fontWeight:'bold'}},'After Discount:'),h('td',{colSpan:2,style:{textAlign:'right',fontWeight:'bold'}},'â‚¹'+tots.afterDisc)),
                            taxInc&&h('tr',{},h('td',{colSpan:7,style:{textAlign:'right'}},'CGST @ 2.5%:'),h('td',{colSpan:2,style:{textAlign:'right'}},'â‚¹'+tots.cg)),
                            taxInc&&h('tr',{},h('td',{colSpan:7,style:{textAlign:'right'}},'SGST @ 2.5%:'),h('td',{colSpan:2,style:{textAlign:'right'}},'â‚¹'+tots.sg)),
                            h('tr',{},h('td',{colSpan:7,style:{textAlign:'right',fontWeight:'bold',fontSize:'14px'}},'GRAND TOTAL:'),h('td',{colSpan:2,style:{textAlign:'right',fontWeight:'bold',fontSize:'14px'}},'â‚¹'+tots.gt))
                        )
                    ),
                    h('div',{className:'print-footer'},h('p',{style:{fontSize:'12px',marginBottom:'15px'}},h('strong',{},'Amount in Words: '),tots.words),h('div',{style:{display:'flex',justifyContent:'space-between',marginTop:'20px'}},h('div',{},h('p',{style:{fontSize:'12px',margin:'2px 0'}},h('strong',{},'Bank Details:')),h('p',{style:{fontSize:'11px',margin:'2px 0'}},'Bank: '+config.bankName),h('p',{style:{fontSize:'11px',margin:'2px 0'}},'A/C: '+config.accountNo),h('p',{style:{fontSize:'11px',margin:'2px 0'}},'IFSC: '+config.ifsc)),h('div',{style:{textAlign:'right'}},h('p',{style:{fontSize:'12px',margin:'2px 0'}},'For '+config.name),h('div',{style:{height:'60px'}}),h('p',{style:{fontSize:'12px',margin:'2px 0',borderTop:'1px solid #000',paddingTop:'5px'}},'Authorized Signatory'))),h('p',{style:{textAlign:'center',fontSize:'10px',marginTop:'20px',fontStyle:'italic'}},'Thank you for your business!'))
                )
            );
        };
        
        // Main App with Auth
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user ?? null);
                    setLoading(false);
                });
                
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user ?? null);
                });
                
                return () => subscription.unsubscribe();
            }, []);
            
            const handleLogout = async () => {
                await supabase.auth.signOut();
                localStorage.removeItem('rememberMe');
                setUser(null);
            };
            
            if (loading) {
                return h('div', { className: 'min-h-screen flex items-center justify-center gradient-bg' },
                    h('div', { className: 'text-center' },
                        h('div', { className: 'loader mx-auto mb-4' }),
                        h('p', { className: 'text-white text-lg' }, 'Loading...')
                    )
                );
            }
            
            if (!user) {
                return h(AuthPage, { onAuthSuccess: setUser });
            }
            
            return h(BillingApp, { user, onLogout: handleLogout });
        };
        
        render(h(App), document.getElementById('root'));
        
    })();
    </script>
</body>
</html>
